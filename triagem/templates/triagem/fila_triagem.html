<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Fila de Triagem</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        body { 
            background-color: #f1f8ff; 
            font-family: Arial, sans-serif; 
        }
        .container { 
            max-width: 900px; 
            margin: 50px auto; 
            padding: 30px; 
            background-color: #fff; 
            border-radius: 10px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); 
        }
        .header-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 30px; 
        }
        .header-row h2 { 
            color: #0057a0; 
            margin: 0; 
        }
        .btn-voltar { 
            display: inline-flex; 
            align-items: center; 
            margin-right: 10px; 
        }
        .btn-voltar i { 
            margin-right: 5px; 
        }
        .card { 
            padding: 15px; 
            border-radius: 10px; 
            color: #fff; 
            font-weight: bold; 
            text-align: center; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
        }
        .card h5 { 
            margin-bottom: 10px; 
        }
        table th, table td { 
            vertical-align: middle !important; 
        }
        .table-striped > tbody > tr:nth-of-type(odd) { 
            background-color: #f9f9f9; 
        }
    </style>
</head>
<body>
<div class="container">

    <!-- Cabeçalho com botão Voltar e Home -->
    <div class="header-row">
        <h2>Fila de Triagem</h2>
        <div>
            <!-- Botão Voltar -->
            <button class="btn btn-secondary btn-voltar" onclick="history.back();" title="Voltar à página anterior">
                <i class="bi bi-arrow-left"></i> Voltar
            </button>

            <!-- Botão Home -->
            <a href="{% url 'enfermeiro_dashboard' %}" class="btn btn-primary btn-voltar" title="Ir para o Dashboard">
    <i class="bi bi-house-door"></i> Home
</a>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="row mb-4 text-center">
        <div class="col-md-4 mb-3">
            <div class="card bg-primary">
                <h5>Total na Fila</h5>
                <h3>{{ total_pacientes }}</h3>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card bg-warning text-dark">
                <h5>Tempo 0-5 min</h5>
                <h3>{{ tempo_espera_0_5 }}</h3>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card bg-danger">
                <h5>Mais de 15 min</h5>
                <h3>{{ tempo_espera_15_ }}</h3>
            </div>
        </div>
    </div>

    <!-- Tabela de pacientes -->
    <table class="table table-striped table-hover">
        <thead class="table-light">
            <tr>
                <th>Paciente</th>
                <th>Hora de Chegada</th>
                <th>Tempo de Espera</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for item in fila %}
            <tr>
                <td>{{ item.paciente.nome }}</td>
                <td>{{ item.data_entrada|date:"H:i:s" }}</td>
                <td>
                    <span class="contador" data-chegada="{{ item.data_entrada|date:'Y-m-d H:i:s' }}"></span>
                </td>
                <td>
                    <a href="{% url 'realizar_triagem' item.paciente.id %}" class="btn btn-primary btn-sm">
                        <i class="bi bi-person-check"></i> Triagem
                    </a>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="4" class="text-center">Nenhum paciente na fila</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Script contador -->
<script>
function atualizarContadores() {
    const elementos = document.querySelectorAll('.contador');
    elementos.forEach(function(el) {
        const chegadaStr = el.getAttribute('data-chegada');
        const chegada = new Date(chegadaStr.replace(' ', 'T')).getTime();
        const agora = new Date().getTime();
        let diff = Math.floor((agora - chegada) / 1000);

        const horas = Math.floor(diff / 3600);
        diff %= 3600;
        const minutos = Math.floor(diff / 60);
        const segundos = diff % 60;

        el.innerText = (horas > 0 ? horas + "h " : "") + minutos + "m " + segundos + "s";
    });
}

// Atualiza a cada segundo
setInterval(atualizarContadores, 1000);
atualizarContadores(); // inicializa imediatamente

// Atualiza a página automaticamente a cada 10 segundos
setTimeout(function() {
    window.location.reload();
}, 10000);
</script>
</body>
</html>
